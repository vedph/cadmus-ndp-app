<form [formGroup]="formCtl" (submit)="save()">
  <mat-tab-group>
    <!-- GENERAL -->
    <mat-tab label="General">
      <div class="form-row">
        <!-- value -->
        <mat-form-field>
          <mat-label>value</mat-label>
          <input matInput [formControl]="value" />
          @if ($any(value).errors?.required && (value.dirty || value.touched)) {
          <mat-error>value required</mat-error>
          } @if ($any(value).errors?.maxLength && (value.dirty ||
          value.touched)) {
          <mat-error>value too long</mat-error>
          }
        </mat-form-field>

        <!-- language (bound) -->
        @if (langEntries()?.length) {
        <mat-form-field>
          <mat-label>language</mat-label>
          <mat-select [formControl]="language">
            @for (e of langEntries(); track e.id) {
            <mat-option [value]="e.id">{{ e.value }}</mat-option>
            }
          </mat-select>
        </mat-form-field>
        } @else {
        <!-- language (free) -->
        <mat-form-field>
          <mat-label>language</mat-label>
          <input matInput [formControl]="language" />
          @if ($any(language).errors?.maxLength && (language.dirty ||
          language.touched)) {
          <mat-error>language too long</mat-error>
          }
        </mat-form-field>
        }
      </div>

      <!-- tags -->
      <div>
        @if (tagEntries()?.length) {
        <div>
          <fieldset>
            <legend>tags</legend>
            <cadmus-thes-entries-picker
              [availableEntries]="tagEntries()!"
              [entries]="tags.value"
              (entriesChange)="onTagEntriesChange($event!)"
            />
          </fieldset>
        </div>
        }
      </div>

      <!-- note -->
      <div>
        <mat-form-field class="long-text">
          <mat-label>note</mat-label>
          <textarea matInput [formControl]="note" rows="3"></textarea>
          @if ($any(note).errors?.maxLength && (note.dirty || note.touched)) {
          <mat-error>note too long</mat-error>
          }
        </mat-form-field>
      </div>
    </mat-tab>

    <!-- TRANSFORMATIONS -->
    <mat-tab label="Transformations">
      <!-- referenceForm -->
      <div>
        <mat-form-field>
          <mat-label>ref. form</mat-label>
          <input matInput [formControl]="referenceForm" />
          @if ($any(referenceForm).errors?.maxLength && (referenceForm.dirty ||
          referenceForm.touched)) {
          <mat-error>reference form too long</mat-error>
          }
        </mat-form-field>
      </div>

      <!-- operations -->
      <div>
        <fieldset>
          <legend>operations</legend>
          <cadmus-edit-operation-set
            [baseText]="sourceText() || ''"
            [targetText]="targetText() || ''"
            [tagEntries]="tagEntries()"
            [opTagEntries]="opTagEntries()"
            [operations]="operations.value"
            (operationsChange)="onOperationsChange($event!)"
          />
        </fieldset>
      </div>
    </mat-tab>

    <!-- REFERENCES -->
    <mat-tab label="References">
      <!-- references -->
      <div>
        <cadmus-refs-lookup-doc-references
          [tagEntries]="refTagEntries()"
          [typeEntries]="refTypeEntries()"
          [references]="references.value"
          (referencesChange)="onReferencesChange($event)"
        />
      </div>

      <!-- links -->
      <div>
        <cadmus-refs-asserted-composite-ids
          [idTagEntries]="linkTagEntries()"
          [assTagEntries]="linkAssTagEntries()"
          [refTagEntries]="refTagEntries()"
          [idScopeEntries]="linkScopeEntries()"
          [refTypeEntries]="refTypeEntries()"
          [ids]="links.value"
          (idsChange)="onLinksChange($event)"
        />
      </div>
    </mat-tab>
  </mat-tab-group>

  <!-- buttons -->
  <div>
    <button
      type="button"
      mat-icon-button
      matTooltip="Discard changes"
      (click)="cancel()"
    >
      <mat-icon class="mat-warn">clear</mat-icon>
    </button>
    <button
      type="submit"
      mat-icon-button
      matTooltip="Accept changes"
      [disabled]="formCtl.invalid || formCtl.pristine"
    >
      <mat-icon class="mat-primary">check_circle</mat-icon>
    </button>
  </div>
</form>
